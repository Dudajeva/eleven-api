<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.adzc.elevenapi.mapper.ChatConversationListMapper">

    <resultMap id="ConversationItemMap" type="org.adzc.elevenapi.message.dto.ConversationItemDTO">
        <result column="conversationId" property="conversationId"/>
        <result column="userId" property="userId"/>
        <result column="nickname" property="nickname"/>
        <result column="avatarUrl" property="avatarUrl"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="tier" property="tier"/>
        <result column="lastMessage" property="lastMessage"/>
        <result column="lastTime" property="lastTime"/>
        <result column="unread" property="unread"/>
    </resultMap>

    <select id="list" resultMap="ConversationItemMap">
        SELECT
        c.id AS conversationId,
        CASE WHEN c.u1_id = #{me} THEN c.u2_id ELSE c.u1_id END AS userId,
        p.nickname AS nickname,
        p.avatar AS avatarUrl,
        p.province AS province,
        p.city AS city,
        msp.level AS tier,
        c.last_preview AS lastMessage,
        c.last_time AS lastTime,
        GREATEST(0, (
        SELECT COUNT(1) FROM chat_message cm
        WHERE cm.conversation_id = c.id
        AND cm.id > COALESCE(mem.last_read_message_id,0)
        AND cm.sender_id &lt;&gt; #{me}
        )) AS unread
        FROM chat_member mem
        JOIN chat_conversation c ON c.id = mem.conversation_id
        JOIN user_profile p ON p.user_id = CASE WHEN c.u1_id = #{me} THEN c.u2_id ELSE c.u1_id END
        LEFT JOIN membership msp ON msp.user_id = p.user_id
        WHERE mem.user_id = #{me} AND mem.deleted_at IS NULL
        ORDER BY c.last_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

</mapper>
