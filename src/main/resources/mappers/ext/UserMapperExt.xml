<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.adzc.elevenapi.mapper.UserMapper">

    <select id="findByIdentity" parameterType="string" resultMap="BaseResultMap">
        SELECT *
        FROM user
        WHERE identity = #{identity}
        LIMIT 1
    </select>


    <select id="countUsers" resultType="long">
        SELECT COUNT(*) FROM user
    </select>

    <!-- 首页 Feed：为避免敏感字段外泄，显式列字段并做别名 -->
    <select id="selectUserCards" resultType="org.adzc.elevenapi.home.dto.UserCard">
        SELECT
        u.id,
        up.nickname        AS name,
        up.age             AS age,
        up.gender          AS gender,
        up.province        AS province,
        up.city            AS city,
        u.tier            AS tier,
        up.photo_url       AS photoUrl
        FROM user u
        join user_profile up on u.id=up.user_id
        WHERE u.id &lt;&gt; #{userId}
        ORDER BY u.updated_at DESC, u.id DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countAllForFeed" resultType="long">
        SELECT COUNT(*) FROM user
    </select>

    <!-- 带省市筛选的分页查询 -->
    <select id="selectUserCardsFiltered" resultType="org.adzc.elevenapi.home.dto.UserCard">
        SELECT
        u.id,
        up.nickname        AS name,
        up.age             AS age,
        up.gender          AS gender,
        up.province        AS province,
        up.city            AS city,
        u.tier            AS tier,
        up.photo_url       AS photoUrl
        FROM user u
        join user_profile up on u.id=up.user_id
        <where>
            u.id &lt;&gt; #{userId}
            <if test="province != null and province != ''">
                AND province = #{province}
            </if>
            <if test="city != null and city != ''">
                AND city = #{city}
            </if>
        </where>
        ORDER BY u.updated_at DESC, u.id DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countForFeedFiltered" resultType="long">
        SELECT COUNT(*) FROM user
        <where>
            <if test="province != null and province != ''">
                AND province = #{province}
            </if>
            <if test="city != null and city != ''">
                AND city = #{city}
            </if>
        </where>
    </select>

    <select id="selectByEmail" parameterType="string" resultMap="BaseResultMap">
        SELECT *
        FROM user
        WHERE email = #{email}
        LIMIT 1
    </select>

    <select id="selectByPhone" parameterType="string" resultMap="BaseResultMap">
        SELECT *
        FROM user
        WHERE phone = #{phone}
        LIMIT 1
    </select>
    <select id="findDetail" parameterType="long" resultType="map">
        SELECT u.id,
        u.identity,
        up.nickname,
        up.avatar_url,
        up.photo_url,
        up.province,
        up.city,
        up.age,
        up.profession,
        up.zodiac,
        up.drinking,
        up.intro,
        um.tier,
        um.expire_time
        FROM user u
        LEFT JOIN user_profile up ON up.user_id = u.id
        LEFT JOIN user_membership um ON um.user_id = u.id
        WHERE u.id = #{userId}
    </select>
</mapper>
